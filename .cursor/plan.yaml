version: 1
name: "Fluxo completo de OS ‚Äî Elisha (tipos + sem cronometro + planos preventivos)"
description: >
  Implementar e persistir templates de checklist e planos de manutencao por tipo de equipamento.
  Gerar automaticamente OS Preventivas no cadastro de cliente/equipamento e de forma recorrente enquanto ativo.
  Manter fluxo sem cronometro (apenas timestamps de transicao). Incluir calendario de manutencao (v1).

env:
  RLS_ENFORCED: "true"
  USE_RPC_ONLY: "true"

style:
  commit_prefix: "feat(os):"
  docs_dir: "docs"
  stop_after_each_step: true

guards:
  - message: "Preservar o que ja foi implementado (steps 00 a 3 concluidos)."
  - message: "Nunca alterar nomes de tabelas/colunas sem mapear o schema real (/docs/context-os.md)."
  - message: "Nao escrever SQL no frontend; usar RPC/Edge Functions via Supabase MCP."
  - message: "Sem cronometro: persistir apenas timestamps de transicao de estados."
  - message: "Respeitar RLS e policies por empresa/usuario/tecnico."
  - message: "Evidencias somente no bucket autorizado, registrando metadados na tabela."
  - message: "Tabs mobile devem exibir 'Concluir' em fluxos progressivos."

# -------------------------------------------------------------------
# DADOS A PERSISTIR (via MCP): templates de checklist e plano preventivo
# -------------------------------------------------------------------
data:
  checklist_templates:
    - tipo_equipamento: "ELEVADOR_ELETRICO"
      norma_base: ["NBR 16083", "NBR 16858-1", "NBR 16858-7", "NM 313"]
      ciclos:
        mensal:
          itens:
            - "Funcionamento das botoeiras de cabine"
            - "Funcionamento das botoeiras de pavimento"
            - "Iluminacao da cabine e ventilador"
            - "Sistema de alarme e interfone"
            - "Nivelamento entre andares dentro da tolerancia da norma"
            - "Ausencia de ruidos, vibracoes ou trancos anormais"
            - "Lubrificacao de guias"
            - "Funcionamento das portas de pavimento e cabina"
            - "Limpeza do poco"
        trimestral:
          itens:
            - "Limpeza de quadro de comando eletrico; conexoes firmes e aterramento correto"
            - "Reaperto de conexoes e conferencias de aterramento"
            - "Limpeza da casa de maquinas e conferencia de iluminacao"
            - "Cabos de tracao e polias sem desgaste ou desfiamento"
            - "Verificacao do limitador de velocidade e freio de emergencia"
            - "Teste dos intertravamentos das portas de pavimento"
            - "Limpeza de contatos de portas de pavimento"
        semestral:
          itens:
            - "Inspecao detalhada no operador de portas"
            - "Limpeza e lubrificacao do operador de portas"
            - "Verificacao da estrutura da cabine e contrapeso"
            - "Teste dos dispositivos de parada e fim de curso"
        anual:
          itens:
            - "Ensaios de seguranca do freio de emergencia"
            - "Auditoria anual de conformidade e emissao de relatorio tecnico"

    - tipo_equipamento: "ELEVADOR_HIDRAULICO"
      norma_base: ["NBR 16083", "NBR 16858-2", "NBR 16858-7", "NM 313"]
      ciclos:
        mensal:
          itens:
            - "Funcionamento das botoeiras de cabine"
            - "Funcionamento das botoeiras de pavimento"
            - "Iluminacao da cabine e ventilador"
            - "Sistema de alarme e interfone"
            - "Nivelamento entre andares dentro da tolerancia da norma"
            - "Ausencia de ruidos, vibracoes ou trancos anormais"
            - "Lubrificacao de guias"
            - "Funcionamento das portas de pavimento e cabina"
            - "Limpeza do poco"
        bimestral:
          itens:
            - "Nivel e qualidade do oleo hidraulico dentro da faixa"
            - "Ausencia de vazamentos em mangueiras, conexoes e cilindros"
            - "Bombas e valvulas sem ruido excessivo"
            - "Funcionamento das botoeiras e alarmes de cabine"
            - "Limpeza geral da casa de maquinas"
            - "Teste do dispositivo de descida de emergencia"
        trimestral:
          itens:
            - "Inspecao detalhada no operador de portas"
            - "Limpeza e lubrificacao do operador de portas"
            - "Verificacao da estrutura da cabine e contrapeso"
            - "Teste dos dispositivos de parada e fim de curso"
        semestral:
          itens:
            - "Verificacao do pistao quanto a corrosao ou empeno"
            - "Inspecao estrutural do cilindro e guias do pistao"
            - "Teste das valvulas de seguranca e travas hidraulicas"
            - "Inspecao do quadro eletrico e aterramento"
            - "Teste do sistema de parada e freio de seguranca"
        anual:
          itens:
            - "Ensaios de seguranca do freio de emergencia"
            - "Auditoria anual de conformidade e emissao de relatorio tecnico"

    - tipo_equipamento: "PLATAFORMA_VERTICAL"
      norma_base: ["NBR 9050", "NBR ISO 9386-1"]
      ciclos:
        mensal:
          itens:
            - "Verificar comandos de subida e descida na cabine"
            - "Verificar comandos de subida e descida no pavimento"
            - "Testar botao de parada de emergencia e alarme sonoro"
            - "Conferir estado estrutural: trincas, corrosao, fixacoes"
            - "Conferir guarda-corpos e fechamento lateral ate 1,10 m"
            - "Verificar sinalizacao visual e tatil conforme NBR 9050"
        bimestral:
          itens:
            - "Inspecionar sistema hidraulico: mangueiras, cilindros, conexoes"
            - "Conferir nivel e contaminacao do fluido hidraulico"
            - "Verificar comunicacao de auxilio: interfone ou botao"
            - "Verificar nivelamento da plataforma em todos os andares"
        semestral:
          itens:
            - "Testar travas de seguranca e antiqueda"
            - "Conferir freios, rodas ou estabilizadores quando aplicavel"
            - "Verificar sinalizacao de area de embarque e desembarque"
            - "Verificar aterramento e quadro eletrico"

  preventive_plan_rules:
    # Regras de agenda por tipo e ciclo (usadas pela geracao de OS preventivas)
    # O agente deve salvar este plano na tabela de planos e associar por empresa/equipamento.
    ELEVADOR_ELETRICO:
      mensal: {intervalo_meses: 1, janela_dias: 7}
      trimestral: {intervalo_meses: 3, janela_dias: 14}
      semestral: {intervalo_meses: 6, janela_dias: 14}
      anual: {intervalo_meses: 12, janela_dias: 30}
    ELEVADOR_HIDRAULICO:
      mensal: {intervalo_meses: 1, janela_dias: 7}
      bimestral: {intervalo_meses: 2, janela_dias: 7}
      trimestral: {intervalo_meses: 3, janela_dias: 14}
      semestral: {intervalo_meses: 6, janela_dias: 14}
      anual: {intervalo_meses: 12, janela_dias: 30}
    PLATAFORMA_VERTICAL:
      mensal: {intervalo_meses: 1, janela_dias: 7}
      bimestral: {intervalo_meses: 2, janela_dias: 7}
      semestral: {intervalo_meses: 6, janela_dias: 14}
      anual: {intervalo_meses: 12, janela_dias: 30}

# -------------------------------------------------------------------
# STEPS NOVOS (mantendo historico dos concluidos)
# -------------------------------------------------------------------
steps:
  # passos ja existentes (mantidos)
  - id: "00-figma-make-referencia"
    name: "Tarefa 00 ‚Äî Ingerir referencia do Figma Make (estrutura do front)"
    status: "‚úÖ COMPLETA"
    completed_at: "2025-11-02"
  - id: "0-map-context"
    name: "Tarefa 0 ‚Äî Mapear schema Supabase e contexto do repo"
    status: "‚úÖ COMPLETA"
    completed_at: "2025-10-24"
  - id: "1-aceitar-recusar"
    name: "Tarefa 1 ‚Äî Dashboard do tecnico + aceitar/recusar"
    status: "‚úÖ COMPLETA"
    completed_at: "2025-10-27"
  - id: "2-fullscreen-sem-cronometro"
    name: "Tarefa 2 ‚Äî Tela Full Screen (sem cronometro) + acoes por status"
    status: "‚úÖ COMPLETA"
    completed_at: "2025-10-28"
  - id: "3-checkin"
    name: "Tarefa 3 ‚Äî Transicao para CHECKIN (Chegada) com timestamp"
    status: "‚úÖ COMPLETA"
    completed_at: "2025-10-28"
  - id: "4-checklist-laudo-evidencias"
    name: "Tarefa 4 ‚Äî Checklist + Laudo + Evidencias"
    status: "‚úÖ COMPLETA"
    completed_at: "2025-10-31"
    notes: "Sistema completo de checklist, laudo com autosave e upload de evidencias implementado"

  # novos passos
  - id: "4a-salvar-templates-checklist"
    name: "Tarefa 4a ‚Äî Persistir templates de checklist por tipo"
    goal: "Salvar no banco os templates definidos em data.checklist_templates via MCP."
    status: "‚úÖ COMPLETA"
    completed_at: "2025-11-06"
    notes: |
      STATUS ATUAL:
      - ‚úÖ Sistema de checklist completo existe (tabelas checklists, os_checklists, checklist_respostas)
      - ‚úÖ Componente ChecklistRunner funcional
      - ‚úÖ Migration APLICADA: campo tipo_equipamento adicionado na tabela checklists
      - ‚úÖ RPC upsert_checklist_templates_by_tipo() criada e verificada
      - ‚úÖ √çndices criados e funcionando
      - ‚úÖ Scripts de seed criados (SQL e TypeScript)
      - ‚è≠Ô∏è PR√ìXIMO: Executar seed de templates (npx tsx scripts/seed-checklist-templates.ts <empresa_id>)
    prompt: |
      1) Criar RPC mcp_upsert_checklist_templates(templates jsonb) ou usar Supabase MCP diretamente.
      2) Cada template recebe: tipo_equipamento, norma_base[], ciclos{frequencia->itens[]}, empresa_id.
      3) Salvar templates definidos em data.checklist_templates para cada empresa.
      4) Garantir snapshot imutavel quando vinculado a uma OS Preventiva (j√° implementado).
    artifacts:
      - path: "supabase/migrations/20251106000000_add_tipo_equipamento_to_checklists.sql"
        status: "Criado"
      - path: "scripts/seed_checklist_templates_by_tipo.sql"
        status: "Criado"
      - path: "scripts/seed-checklist-templates.ts"
        status: "Criado"
      - path: "docs/TASK_4a_COMPLETED.md"
        status: "Criado"
    commit:
      message: "feat(os): persistencia de templates de checklist por tipo (via MCP)"

  - id: "4b-salvar-planos-preventivos"
    name: "Tarefa 4b ‚Äî Persistir plano preventivo por tipo"
    goal: "Salvar regras de agenda por tipo (data.preventive_plan_rules) por empresa."
    status: "‚úÖ COMPLETA"
    completed_at: "2025-11-06"
    notes: |
      STATUS ATUAL:
      - ‚úÖ Migration APLICADA: tabela preventive_plans com RLS e √≠ndices (verificada em 2025-11-06)
      - ‚úÖ Tabela preventive_plans EXISTE no banco
      - ‚úÖ RPC upsert_preventive_plan() criada e verificada
      - ‚úÖ Helper function get_preventive_plan() criada e verificada
      - ‚úÖ √çndices criados e funcionando
      - ‚úÖ Scripts de seed criados (SQL e TypeScript)
      - ‚úÖ 13 planos definidos (ELEVADOR_ELETRICO: 4, ELEVADOR_HIDRAULICO: 5, PLATAFORMA_VERTICAL: 4)
      - ‚è≠Ô∏è OPCIONAL: Executar seed de planos (npx tsx scripts/seed-preventive-plans.ts <empresa_id>)
    prompt: |
      1) Criar tabela maintenance_plans ou preventive_plans no banco.
      2) Criar RPC mcp_upsert_preventive_plan(plan jsonb) ou usar Supabase MCP diretamente.
      3) Estrutura: {tipo_equipamento, frequencia: {intervalo_meses, janela_dias}, empresa_id}.
      4) Validar conflito de planos existentes; manter apenas o ativo mais recente.
      5) Salvar planos definidos em data.preventive_plan_rules.
    artifacts:
      - path: "supabase/migrations/20251106000001_create_preventive_plans.sql"
        status: "Criado"
      - path: "scripts/seed-preventive-plans.ts"
        status: "Criado"
      - path: "scripts/seed_preventive_plans.sql"
        status: "Criado"
      - path: "docs/TASK_4b_COMPLETED.md"
        status: "Criado"
    commit:
      message: "feat(os): plano preventivo por tipo salvo no banco (via MCP)"

  - id: "4c-auto-geracao-os-preventivas"
    name: "Tarefa 4c ‚Äî Gerar OS Preventivas no cadastro e recorrencia"
    goal: >
      Ao cadastrar cliente e seus equipamentos, gerar automaticamente todas as OS preventivas conforme o plano.
      Enquanto cliente estiver ativo, continuar gerando OS futuras.
    status: "‚úÖ COMPLETA"
    completed_at: "2025-11-06"
    notes: |
      STATUS ATUAL:
      - ‚úÖ Migration criada: sistema completo de gera√ß√£o autom√°tica de OS preventivas
      - ‚úÖ Fun√ß√£o calculate_next_preventive_date() criada
      - ‚úÖ RPC generate_preventive_os_for_equipment() criada e funcional
      - ‚úÖ Trigger AFTER INSERT em equipamentos criado
      - ‚úÖ RPC os_preventive_rollforward() criada para job recorrente
      - ‚úÖ Job recorrente configurado (pg_cron, opcional)
      - ‚úÖ Vincula√ß√£o autom√°tica de checklist template ao criar OS
      - ‚è≠Ô∏è PR√ìXIMO: Aplicar migration e testar gera√ß√£o autom√°tica
    prompt: |
      Backend:
        1) Criar Edge Function os_on_customer_equipment_created:
           - Input: empresa_id, cliente_id, equipamento_id, tipo_equipamento.
           - Carregar plano preventivo por tipo e gerar OS baseadas nas frequencias.
           - Criar OS com: tipo=preventiva, status=novo, tecnico_id=null, data_programada=auto (primeira data util da janela).
           - Vincular snapshot do checklist template ao criar a OS (usar startChecklistForOS).
        2) Criar trigger AFTER INSERT em equipamentos que chama a Edge Function.
        3) Criar Job recorrente os_preventive_rollforward (cron via pg_cron ou Supabase Edge Function):
           - Mensal: gera proximo ciclo para clientes ativos, respeitando janela_dias.
           - Nao reabrir OS antigas; apenas criar futuras quando nao existirem.
      UI:
        - Nenhuma atribuicao padrao de tecnico; permitir posterior atribuicao e re-agendamento.
    artifacts:
      - path: "supabase/migrations/20251106000002_create_preventive_os_generation.sql"
        status: "Criado"
      - path: "docs/TASK_4c_COMPLETED.md"
        status: "Criado"
    commit:
      message: "feat(os): geracao automatica de OS preventivas no cadastro e recorrencia"

  - id: "4d-atribuir-tecnico-e-reagendar"
    name: "Tarefa 4d ‚Äî Atribuir tecnico e alterar datas"
    goal: "Permitir que usuarios designem tecnico e alterem data de OS Preventiva."
    status: "‚è≥ PENDENTE"
    notes: |
      STATUS ATUAL:
      - ‚ùå RPC os_assign_technician N√ÉO existe
      - ‚ùå RPC os_reschedule N√ÉO existe
      - ‚ùå UI para atribuir t√©cnico N√ÉO existe
      - ‚ùå UI para reagendar N√ÉO existe
    prompt: |
      1) Criar RPC os_assign_technician(os_id uuid, tecnico_id uuid).
      2) Criar RPC os_reschedule(os_id uuid, data_programada date, motivo text default null).
      3) RLS: apenas gestor/admin pode atribuir tecnico; tecnico pode sugerir re-agendamento se permitido pela empresa.
      4) UI: dialogo com busca de tecnico, datepicker e validacoes de conflito.
      5) Integrar na p√°gina de OS e no calend√°rio (quando implementado).
    artifacts:
      - path: "supabase/migrations/XXX_create_assign_reschedule_rpcs.sql"
        status: "Pendente"
      - path: "src/components/os-assign-technician-dialog.tsx"
        status: "Pendente"
      - path: "src/components/os-reschedule-dialog.tsx"
        status: "Pendente"
    commit:
      message: "feat(os): atribuicao de tecnico e reagendamento de OS preventiva"

  - id: "4e-calendario-manutencao-v1"
    name: "Tarefa 4e ‚Äî Calendario de manutencao (v1) no sidebar"
    goal: "Nova aba 'Calendario' exibindo OS preventivas e corretivas agendadas."
    status: "‚è≥ PENDENTE"
    notes: |
      STATUS ATUAL:
      - ‚ùå Rota /calendar N√ÉO existe
      - ‚ùå Aba 'Calendario' no sidebar N√ÉO existe
      - ‚ùå Componente de calend√°rio N√ÉO existe
    prompt: |
      1) Criar rota src/app/(protected)/calendar/page.tsx.
      2) Adicionar aba 'Calendario' no sidebar (verificar src/components/ui/sidebar.tsx).
      3) Usar componente de calendario do shadcn (time/calendar.mdx) ou react-day-picker.
      4) Carregar OS por intervalo (data_programada) e pintar por tipo/prioridade (sem cronometro).
      5) Click em evento -> sheet com detalhes e acoes: atribuir tecnico, reagendar, abrir OS.
      6) Respeitar RLS na listagem (filtrar por empresa_id).
    artifacts:
      - path: "src/app/(protected)/calendar/page.tsx"
        status: "Pendente"
      - path: "src/components/maintenance-calendar.tsx"
        status: "Pendente"
    commit:
      message: "feat(os): calendario de manutencao v1 no sidebar"

  - id: "4f-integrar-atendimento-por-tipo"
    name: "Tarefa 4f ‚Äî Integracao com passo 4-atendimento-por-tipo"
    goal: "Renderizar checklist somente em Preventiva, laudo em Chamado/Corretiva."
    status: "üîÑ PARCIAL"
    notes: |
      STATUS ATUAL:
      - ‚úÖ Componentes PreventiveOS, CallOS, CorrectiveOS existem
      - ‚úÖ ChecklistRunner funcional e integrado
      - ‚úÖ Laudo e evid√™ncias implementados
      - ‚ö†Ô∏è Checklist n√£o est√° vinculado automaticamente por tipo de equipamento
      - ‚ö†Ô∏è Templates por tipo de equipamento n√£o existem (depende de 4a)
    prompt: |
      1) Vincular checklist template automaticamente ao criar OS Preventiva baseado no tipo de equipamento.
      2) Usar snapshot de checklist vinculado a OS Preventiva (j√° implementado).
      3) Gravar respostas como conforme/nao conforme/nao aplicavel (j√° implementado).
      4) Observacoes e evidencias em sessoes proprias (j√° implementadas).
      5) Garantir que Preventiva mostra checklist, Chamado/Corretiva mostra laudo (j√° implementado).
    commit:
      message: "feat(os): integracao do checklist preventivo com atendimento por tipo"

  - id: "5-checkout-estado-ramificacoes"
    name: "Tarefa 5 ‚Äî Checkout + Estado do elevador + Ramificacoes"
    goal: "Manter regras definidas e criar corretiva programada/urgencia conforme estado."
    prompt: "Sem alteracoes de escopo; reusar implementacao planejada."
  - id: "6-timeline-relatorio"
    name: "Tarefa 6 ‚Äî Timeline/Relatorio"
    goal: "Consolidar historico, evidencias e checklist/laudo por tipo."
    prompt: "Sem cronometro; apenas timestamps e duracao calculada."
  - id: "7-reabertura"
    name: "Tarefa 7 ‚Äî Reabrir OS"
    goal: "Reabrir OS com rastreabilidade."
  - id: "8-validacao-final"
    name: "Validacao Final ‚Äî E2E + SLA summary"
    goal: "Executar E2E e publicar resumo para dashboards."

progress:
  current_step: "4d-atribuir-tecnico-e-reagendar"
  completed_steps: ["00-figma-make-referencia", "0-map-context", "1-aceitar-recusar", "2-fullscreen-sem-cronometro", "3-checkin", "4-checklist-laudo-evidencias", "4a-salvar-templates-checklist", "4b-salvar-planos-preventivos", "4c-auto-geracao-os-preventivas"]
  pending_steps: ["4d-atribuir-tecnico-e-reagendar", "4e-calendario-manutencao-v1", "4f-integrar-atendimento-por-tipo", "5-checkout-estado-ramificacoes", "6-timeline-relatorio", "7-reabertura", "8-validacao-final"]
  completion_percentage: 62.0
  migration_status:
    "4a": "‚úÖ APLICADA - Verificada em 2025-11-06"
    "4b": "‚úÖ APLICADA - Verificada em 2025-11-06 (4/4 verifica√ß√µes passaram)"

postflight:
  - message: "Templates e plano preventivo salvos via MCP; geracao de OS automatica ao cadastrar cliente/equipamento e recorrencia ativa."
  - message: "OS preventivas criadas sem tecnico e com data automatica; usuarios podem atribuir tecnico e reagendar."
  - message: "Calendario de manutencao (v1) adicionado ao sidebar com shadcn calendar."

# -------------------------------------------------------------------
# RESUMO DO STATUS ATUAL
# -------------------------------------------------------------------
status_summary:
  implementado:
    - "Sistema completo de checklist (tabelas, RLS, ChecklistRunner)"
    - "Laudo t√©cnico com autosave (4 campos, debounce 2s)"
    - "Upload de evidencias (foto/video/audio/nota)"
    - "Componentes OS por tipo (PreventiveOS, CallOS, CorrectiveOS)"
    - "Fluxo de aceitar/recusar OS"
    - "Check-in com timestamp"
    - "Full-screen OS page"
    - "Sistema de evid√™ncias com bucket privado"
    - "Templates de checklist por tipo de equipamento (4a) - 12 templates criados + Migration aplicada"
    - "Planos preventivos por tipo (4b) - 13 planos criados + Migration aplicada"
    - "Gera√ß√£o autom√°tica de OS preventivas (4c) - Trigger + RPC + Job recorrente criados"
  pendente:
    - "Atribui√ß√£o de t√©cnico e reagendamento (4d)"
    - "Calend√°rio de manuten√ß√£o (4e)"
    - "Integra√ß√£o completa checklist por tipo (4f - parcial)"
    - "Checkout com estado do elevador (5)"
    - "Timeline/Relat√≥rio (6)"
    - "Reabertura de OS (7)"
    - "Valida√ß√£o final E2E (8)"
  proximos_passos:
    - "1. ‚úÖ Implementar 4a: Criar templates de checklist por tipo de equipamento (CONCLU√çDO + MIGRATION APLICADA)"
    - "1.1. ‚è≠Ô∏è OPCIONAL: Executar seed de templates (npx tsx scripts/seed-checklist-templates.ts <empresa_id>)"
    - "2. ‚úÖ Implementar 4b: Criar tabela e RPCs para planos preventivos (CONCLU√çDO + MIGRATION APLICADA)"
    - "2.1. ‚è≠Ô∏è OPCIONAL: Executar seed de planos (npx tsx scripts/seed-preventive-plans.ts <empresa_id>)"
    - "3. ‚úÖ Implementar 4c: Gera√ß√£o autom√°tica de OS preventivas (CONCLU√çDO)"
    - "3.1. ‚è≠Ô∏è APLICAR: Migration 4c no dev branch (supabase/migrations/20251106000002_create_preventive_os_generation.sql)"
    - "4. üéØ PR√ìXIMO: Implementar 4d: RPCs e UI para atribuir t√©cnico e reagendar"
    - "5. Implementar 4e: Calend√°rio de manuten√ß√£o no sidebar"
